# SpamGuard Bot 要件定義書（py-cord）

## 1. 目的・背景
### 1.1 目的
Discordサーバーにおけるスパム行為（連投、リンク乱投、メンション荒らし等）を自動検知し、段階的な抑止（削除・警告・タイムアウト・通報）を行うBotを提供する。

### 1.2 対象範囲
- 対象：サーバー（Guild）内のテキスト投稿（通常メッセージ）
- 対象外：DM、ボイスチャット、外部SNS監視、画像OCR、機械学習による高度解析

### 1.3 成果物
- Bot本体（Python + py-cord）
- 設定ファイル（.env、JSONまたはSQLite）
- 運用マニュアル

---

## 2. 用語
- **スパム**：短時間での連投、同文連投、URL乱投、過剰メンションなどの迷惑行為  
- **モデレーション**：削除、警告、タイムアウト、キック/バンなどの措置  
- **スコア方式**：条件ごとに点数を加算し閾値で判定する方式  

---

## 3. 利用者・権限

### 3.1 利用者
- 一般ユーザー：通常の投稿者（スパム判定対象）
- モデレーター：Bot設定の変更・ログ確認
- 管理者：Botの導入・権限付与・全管理

### 3.2 Botに必要なDiscord権限
- Read Messages  
- Message Content Intent  
- Manage Messages（メッセージ削除用）  
- Moderate Members（タイムアウト用）  
- Send Messages（ログ出力用）

---

## 4. 機能要件

### 4.1 スパム検知

Botはメッセージ受信時に以下のルールでスコアを算出する。

#### 4.1.1 連投検知
- 一定時間内の投稿数を監視  
- 例：12秒以内に5件以上でスコア +2

#### 4.1.2 同文連投検知
- 正規化した同一内容の連続投稿を監視  
- 120秒以内に3回以上でスコア +3

#### 4.1.3 URL乱投検知
- 投稿内URL数をカウント  
- 2個以上でスコア +3

#### 4.1.4 過剰メンション検知
- メンション数が多い場合に加点  
- 4件以上でスコア +3

#### 4.1.5 新規アカウント加点
- アカウント作成から24時間未満で +1

#### 4.1.6 判定
- 合計スコアが閾値（例：6点）以上でスパムと判定

---

### 4.2 モデレーション処理

スパム判定時に以下を順に実行

1. メッセージ削除  
2. ユーザーのタイムアウト  
3. ログチャンネルへ記録

---

### 4.3 設定管理

#### 管理用コマンド
- `/spamguard status` – 現在の設定表示  
- `/spamguard set <key> <value>` – 設定変更  
- `/spamguard ignore add <role/channel>` – 例外登録  
- `/spamguard ignore remove <role/channel>` – 例外解除  

#### 保存方式
- 初期：JSONファイル  
- 拡張：SQLiteデータベース

---

## 5. 非機能要件

### 5.1 性能
- 1メッセージ処理は軽量に実行  
- ユーザー履歴は固定長で保持しメモリを圧迫しない

### 5.2 信頼性
- 権限不足でもBotは停止しない  
- 例外発生時はログに記録

### 5.3 セキュリティ
- トークンは.envで管理  
- 不要な個人情報は保存しない

---

## 6. 受け入れ条件

- 連投・同文・URL乱投・メンション荒らしが正しく検知される  
- 閾値超過で削除・タイムアウトが実行される  
- 権限不足時もエラーで停止しない  
- 例外チャンネル・例外ロールが正しく機能する  

---

## 7. 初期パラメータ例

- WINDOW_SEC = 12  
- MAX_MSG_IN_WINDOW = 5  
- DUP_THRESHOLD = 3  
- URL_THRESHOLD = 2  
- MENTION_THRESHOLD = 4  
- SCORE_THRESHOLD = 6  
- TIMEOUT_MINUTES = 10  

---

Codex_Agents.mdの指示通りに生成すること。
以上をもって、SpamGuard Botの要件定義とする。
